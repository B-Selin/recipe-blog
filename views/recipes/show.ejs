<%- include('../partials/header') %>

<!-- show the title of the recipe-->
<div class="container">

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title"><%= recipe.title %></h5>

        <!-- add the user who created the recipe -->
      <p class="card-text">By <%= recipe.user.name %></p>
    </div>
  </div>

  <!-- show the ingredients as an unordered list  -->
  <div class="card mb-3">
    <div class="card-header">
      Ingredients
    </div>
    <ul class="list-group list-group-flush">
      <li><%= recipe.ingredients %> </li>
      <li><%= recipe.amount %> </li>
    </ul>
  </div>

  <!-- explain how to make the recipe -->
  <div class="card mb-3">
    <div class="card-header">
      How to:
    </div>
    <p class="card-title"><%= recipe.howTo %></p>

  </div>



  <table class="table table-hover">
    <div class="reviews"> 
      <% if (recipe.reviews.length) { %>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Review</th>
              <th>User</th>
            </tr>
          </thead>
          <tbody>
            <% recipe.reviews.forEach(function(r) { %>
              <tr>
                <td><%= r.createdAt.toLocaleDateString() %></td>
                <td><%= r.content %></td>
                <td class="review-user"><%= r.userName %></td>
                <td>
                  <% if (user?._id.equals(r.user._id)) { %>
                    <form action="/reviews/<%= r._id %>?_method=DELETE" method="POST">
                      <button type="submit">X</button>
                    </form>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %>
        <h5>No Reviews Yet</h5>
      <% } %>
    </div>
  </table>



  <!-- Make edit and delete buttons visible if only the user id matches the user who posted the recipe -->
  <% if (user) { %>

    <% if(user._id.equals(recipe.user._id)) { %>
        <!-- edit button that will send user to edit form -->
      <div class="d-flex justify-content-between">

        <div>  
          <button class="btn btn-warning">
            <a href="/recipes/<%= recipe._id %>/edit" class="text-white">Edit</a>
          </button>
        </div>


        <!-- delete button -->
        <div>
          <form id="delete" action="/recipes/<%= recipe._id %>?_method=DELETE" method="POST">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </form>
    <% }; %>
    <!-- keep the 'add comment' section out of the if(user._id.equals(recipe.user._id) conditional, but inside the if (user) conditional -->
    <!-- Logged in users can capp comments -->
    <form class="form" id="add-review-form" method="POST" action="recipes/<%= recipe._id %>/reviews">
      <div class="form-group">
        <label>Review:</label>
        <textarea class="form-control"></textarea>
      </div>
      <button class="btn btn-primary m-3">Add Review</button>
    </form>
  <% }; %>

  
</div>

<%- include('../partials/footer') %>